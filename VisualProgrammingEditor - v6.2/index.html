
  <!DOCTYPE html>
  <html lang="en" xmlns = "http://www.w3.org/1999/xhtml">
  <head>
    <script src="https://unpkg.com/gojs@2.2.13/release/go.js"></script>
    <script src="parser.js"></script>
    <script src="generator.js"></script>
    <script src="styles/style.js"></script>
    <script src="styles/functionstyle.js"></script>
    <script src="styles/ArgumentStyles/DefaultArgumentStyle.js"></script>
    <script src="styles/ArgumentStyles/DeclArgumentStyle.js"></script>
    <script src="styles/ArgumentStyles/VarArgumentStyle.js"></script>
    <script src="styles/ArgumentStyles/GetElemArgumentStyle.js"></script>
    <script src="styles/ArgumentStyles/FunParameterStyle.js"></script>
    <script src="styles/blockstyle.js"></script>
    <script src="textEditor/dropdownEditors.js"></script>

    <link rel="stylesheet" type="text/css"href="css/tabstyle.css">
    <link rel="stylesheet" href="css/textfieldsstyle.css">
    <link rel="stylesheet" href="css/debugBar.css">

    <style type="text/css">
    .tab-label::after {
      content: "‚ùØ";
      width: 1em;
      height: 1em;
      text-align: center;
      transition: all 0.35s;
    }
    </style>

    <script id="code">
    
      const resultLines = [];
      var resultStore = false;
      
      //remove comments for printing result
      /*console.oldLog = console.log;
      console.log = function(value)
      {
        console.oldLog(value);
        resultStore ? resultLines.push(value) : null;
        return value;
      };*/
      
      const $ = go.GraphObject.make;  // for conciseness in defining templates
    
      function init() {
        document.body.style.backgroundColor = "#36393f";

        function makePattern() {
          var patternCanvas = document.createElement('canvas');
          patternCanvas.width = 40;
          patternCanvas.height = 69.3;
          var pctx = patternCanvas.getContext('2d');

          // This creates a shape similar to a diamond leaf
          pctx.beginPath();
          pctx.moveTo(0.0, 34.1);
          pctx.lineTo(40.0, 34.1);
          pctx.lineTo(20.0, 0.0);
          pctx.lineTo(0.0, 34.1);
          pctx.lineTo(20.0, 69.3);
          pctx.lineTo(40.0, 34.1);
          pctx.moveTo(0.0, 69.3);
          pctx.lineTo(40.0, 69.3);
          pctx.moveTo(0.0, 0.0);
          pctx.lineTo(40.0, 0.0);
          pctx.closePath();
          pctx.fillStyle = "#ffffff";
          pctx.fill();
          pctx.lineWidth = 0.8;
          pctx.strokeStyle = "#202020";
          pctx.lineJoin = "miter";
          pctx.miterLimit = 4.0;
          pctx.stroke();

          return patternCanvas;
        }

        myDiagram =
          $(go.Diagram, "myDiagramDiv",  // create a new Diagram in the HTML DIV element "myDiagramDiv"
            {
              "LinkDrawn": onLinkDrawVarUpdate, //it first updates model
              "undoManager.isEnabled": true,
              "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
              "dragSelectingTool.canStart": function() {
                if (!this.isEnabled) return false;
                const diagram = this.diagram;
                if (!diagram.allowSelect) return false;
                const e = diagram.lastInput;
                if (!e.right) return false; // require left button
                // don't include the following checks when this tool is running modally
                if (diagram.currentTool !== this) {
                  if (!this.isBeyondDragSize()) return false; // must not be a click
                  // don't start if we're over a selectable part
                  if (diagram.findPartAt(e.documentPoint, true) !== null) return false;
                }
                return e.right;  // only when the Shift key is also held down
              },
              grid: $(go.Panel, "Grid",  // a simple 10x10 grid
                { gridCellSize: new go.Size(40, 69.3) },
                $(go.Shape, "BarH", { fill: $(go.Brush, "Pattern", { pattern: makePattern()}) }),
              ),
			  		  initialAutoScale: go.Diagram.Uniform,
			  		  initialContentAlignment: go.Spot.Left,
              layout: $(go.LayeredDigraphLayout, { isInitial: false,isOngoing: false, layerSpacing: 50})
            },
            {
              click: (e, obj) => { //make this function
                myDiagram.nodes.each(function (n) {
                  if(n.data.type == "args" || n.data.type == "var" || n.data.type == "decl" || n.data.type == "propertyAccesors" || n.data.type == "parameters") {
                    n.elt(0).elt(0).elements.each(it => {
                      setArgSelected(it.elt(0), false);
                    });
                    n.removeAdornment(mouseSettingsSelect);
                    n.removeAdornment(settingsMenuSelect);
                  }
                })
              }
            });

        myDiagram.padding.right = 200;
        
        // when the document is modified, enable the "Save" button
        myDiagram.addDiagramListener("Modified", e => { //name "Modified" is built-in
          var button = document.getElementById("saveModel");
          if (button) button.disabled = !myDiagram.isModified;
        });

        myDiagram.addDiagramListener("ExternalObjectsDropped", e => {
          // stop any ongoing text editing
          if (myDiagram.currentTool instanceof go.TextEditingTool) {
            myDiagram.currentTool.acceptText(go.TextEditingTool.LostFocus);
          }
          fading(); // expand any "macros"
        });

        function fading() {
          setTimeout(() => {myDiagram.commandHandler.ungroupSelection()}, 0)
        }

        myDiagram.addDiagramListener("ViewportBoundsChanged", function(e) {
          // only iterates through simple Parts in the diagram, not Nodes or Links
          myDiagram.parts.each(function(part) {
            // and only on those that have the "_viewPosition" property set to a Point
            if (part._viewPosition) {
              part.position = myDiagram.transformViewToDoc(part._viewPosition);
              part.scale = 1/myDiagram.scale;  // counteract any zooming
            }
          })
        });

        var greenArrowBrush = "#006600";
        var greenArrowHeadBrush = "#00FF00";
        var blueArrowBrush = "#003366";
        var blueArrowHeadBrush = "#3399FF";
        var purpleArrowBrush = "#4C0099";

        // creates relinkable Links that will avoid crossing Nodes when possible and will jump over other Links in their paths
        myDiagram.linkTemplate =
          $(go.Link,
            new go.Binding("points").makeTwoWay(),
            {
              routing: go.Link.AvoidsNodes,
              curve: go.Link.JumpOver,
              //corner: 3,
              relinkableFrom: true, relinkableTo: true,
              selectionAdorned: false, // Links are not adorned when selected so that their color remains visible.
              shadowOffset: new go.Point(0, 0), shadowBlur: 5, shadowColor: "red"
            },
            new go.Binding("isShadowed", "isSelected").ofObject(),
            $(go.Shape,
              { name: "SHAPE", strokeWidth: 3, stroke: blueArrowBrush}
            ),
            $(go.Shape,
              { toArrow: "Standard"},
              { name: "SHAPE", strokeWidth: 3, stroke: blueArrowHeadBrush , fill: blueArrowHeadBrush}
            )
            );

          myDiagram.linkTemplateMap.add("Reversed",
              $(go.Link,
                new go.Binding("isShadowed", "isSelected").ofObject(),
                {selectionAdorned: false, // Links are not adorned when selected so that their color remains visible.
                shadowOffset: new go.Point(0, 0), shadowBlur: 10, shadowColor: "red"},
                $(go.Shape, { strokeWidth: 4, stroke: greenArrowBrush }),
                $(go.Shape, { strokeWidth: 2, fromArrow: "Backward" , stroke: greenArrowHeadBrush, fill: greenArrowHeadBrush}),
              )
            );

          myDiagram.linkTemplateMap.add("BlockToNode",
            $(go.Link,
              new go.Binding("isShadowed", "isSelected").ofObject(),
              {selectionAdorned: false, // Links are not adorned when selected so that their color remains visible.
              shadowOffset: new go.Point(0, 0), shadowBlur: 10, shadowColor: "red"},
              $(go.Shape, { strokeWidth: 4, stroke: purpleArrowBrush })
            )
          );
              
        // add the templates created above to myDiagram and myPalette
        const objectsMap = {
          "arithmeticOperator": {"ARITHMETIC OP":	yellowgrad},
          "relationalOperator": {"RELATIONAL OP":	yellowgreengrad},
          "unaryOperator":      {"UNARY OP":	    yellowbluegrad},
          "binaryOperator":     {"BINARY OP":	    yellowredgrad},
          "print":              {"PRINT":	        orangegrad},
          "varsDecl":           {"VAR DECL":	    lightbluegrad},
          "varsRefer":          {"VAR":	          purplegrad},
          "getElem":            {"GET ELEM":      redpinkgrad},
          "if":                 {"IF":	          greengrad},
          "while":              {"WHILE":	        greengrad},
          "for":                {"FOR":	          greengrad},
          "break":              {"BREAK":         "white"},
          "continue":           {"CONTINUE":      "white"},
          "return":             {"RETURN":        "white"},
          "assign":             {"ASSIGN":        bluegrad},
          "object":             {"OBJECT":        browngrad},
          "function":           {"FUNCTION":      "white"},
          "call":               {"CALL":          "white"},
        }

        //NODES
        Object.keys(objectsMap).forEach(key => {
          let shapeColor = Object.values(objectsMap[key])[0];
          let functionName = Object.keys(objectsMap[key])[0];
          myDiagram.nodeTemplateMap.add(key, $(go.Node, "Spot", nodeFunctionStyle(  shapeColor,  functionName  )));
          myDiagram.groupTemplateMap.add(key+"Group", $(go.Group, groupFunctionStyle(  shapeColor,  functionName  )));
        })
        
        //ARGS
        myDiagram.nodeTemplateMap.add("args", argsTemplate);
        myDiagram.nodeTemplateMap.add("var", varArgsTemplate);
        myDiagram.nodeTemplateMap.add("propertyAccesors", getElemArgsTemplate);//entries
        myDiagram.nodeTemplateMap.add("decl", varDeclArgsTemplate);
        myDiagram.nodeTemplateMap.add("parameters", funParamsTemplate);
        //BLOCKS
        myDiagram.nodeTemplateMap.add("blocks", blocksTemplate);
        myDiagram.nodeTemplateMap.add("mainBlock", mainBlockTemplate);
        myDiagram.nodeTemplateMap.add("funBlocks", funBlocksTemplate);

        myDiagram.add(recycleTemplate);

        myPalette =  $(go.Palette, "myPaletteDiv",  // must name or refer to the DIV HTML element
          {
            nodeTemplateMap: myDiagram.nodeTemplateMap,  // share the templates used by myDiagram
            groupTemplateMap: myDiagram.groupTemplateMap,
            //autoScale: go.Diagram.Uniform,

            model: new go.GraphLinksModel(paletteComps,paletteLinks)
          });  // create a new Palette in the HTML DIV element "palette"

        myPalette2 = $(go.Palette, "myPaletteDiv2",  // must name or refer to the DIV HTML element
          {
            nodeTemplateMap: myDiagram.nodeTemplateMap,  // share the templates used by myDiagram
            groupTemplateMap: myDiagram.groupTemplateMap,
            //autoScale: go.Diagram.Uniform,

            model: new go.GraphLinksModel(paletteComps2,paletteLinks2)
          });

        myPalette3 = $(go.Palette, "myPaletteDiv3",
          {
            nodeTemplateMap: myDiagram.nodeTemplateMap,
            groupTemplateMap: myDiagram.groupTemplateMap,
            //autoScale: go.Diagram.Uniform,

            model: new go.GraphLinksModel(paletteComps3, paletteLinks3)
          });

        myPalette.model.nodeCategoryProperty = "type";
        myPalette2.model.nodeCategoryProperty = "type";
        myPalette3.model.nodeCategoryProperty = "type";

        function editText(e, button) {
          var node = button.part.adornedPart;
          e.diagram.commandHandler.editTextBlock(node.findObject("TEXTBLOCK"));
        }
        
        var renameContextMenu = $("ContextMenu",
            $("ContextMenuButton",
              $(go.TextBlock, "Rename"),
              { click: editText }),
            $("ContextMenuButton",
              $(go.TextBlock, "Delete"),
              { click: function(e, button) {
                  var node = button.part.adornedPart;
                  e.diagram.select(node);
                  e.diagram.commandHandler.deleteSelection();
                }
              })
          );

        myDiagram.nodeTemplateMap.get("function").contextMenu = renameContextMenu;
        myDiagram.nodeTemplateMap.get("call").contextMenu = renameContextMenu;

        function maybeChangeLinkCategory(e) {
          var link = e.subject;
          var blocktonode = false;
          console.log("in change link")
          if(link.fromNode.name == "blocks"){
            blocktonode = true;
          }
          e.diagram.model.setCategoryForLinkData(link.data, (blocktonode ? "BlockToNode" : ""));
        }

        function onLinkDrawVarUpdate(e){
          var link = e.subject;
          maybeChangeLinkCategory(e)
          updateDecls();
          n = myDiagram.findNodeForKey(link.data.to); // get the node to where link drew
          updateVar(n);
          if(n.data.type == "varsDecl") { updateVars() }
          updateCall(n);
          if(n.data.type == "function") { updateCalls() }
        }
        
        // load the initial diagram
        load();
        save();
        layout();
      }
    </script>

    <script src="templates/functionsTemplates.js"></script>
    <script src="templates/argTemplate.js"></script>
    <script src="templates/blockTemplate.js"></script>
    <script src="templates/recycleTemplate.js"></script>
    <script src="palettes/StatementsPalette.js"></script>
    <script src="palettes/ExpressionsPalette.js"></script>
    <script src="palettes/FunctionsPalette.js"></script>
    <script src="savenload.js"></script>

  </head>

  <body onload="init()">
    <div id="sample">

    <div class="editor-toolbar">
      <div class="editor-toolbar-logo">
        <img class="logo-image" src="logo/CodeChainsLogo.png" width="130" height="25">
      </div>
      <div class ="top-toolbar-buttons">
        <div class="undo-button"></div><!-- undo -->
        <div class="redo-button"></div><!-- redo -->
      </div>
    </div>

    <div style="width: 100%; display: flex; justify-content: space-between">
      <div class="tabs">
        <div class="tab">
          <input type="radio" id="rd1" name="rd" checked="true">
          <label class="tab-label" for="rd1">Statements</label>
          <div class="tab-content">
            <div id="myPaletteDiv" style="width: 120px; height: 24.75em; margin-right: 2px; background-color: whitesmoke; border: 1px solid black; position: relative;"></div>
          </div>
        </div>
        <div class="tab">
          <input type="radio" id="rd2" name="rd">
          <label class="tab-label" for="rd2">Expressions</label>
          <div class="tab-content">
            <div id="myPaletteDiv2" style="width: 120px; height: 24.75em; margin-right: 2px; background-color: whitesmoke; border: 1px solid black; position: relative;"></div>
          </div>
        </div>
        <div class="tab">
          <input type="radio" id="rd3" name="rd">
          <label class="tab-label" for="rd3">Functions</label>
          <div class="tab-content">
            <div id="myPaletteDiv3" style="width: 120px; height: 24.75em; margin-right: 2px; background-color: whitesmoke; border: 1px solid black; position: relative;"></div>
          </div>
        </div>
      </div>

      <div id="myDiagramDiv" style="flex-grow: 1; height: 500px; background-color: #ffffff; border: 1px solid black; position: relative;"></div>
      
    </div>
    <div>
      <div>
        <button class="controls__button controls__button--load" id="saveModel" onclick="save()">Save</button>
        <button class="controls__button controls__button--load" onclick="load()">Load</button>
        <button class="controls__button controls__button--layout" onclick="layout()">Do Layout</button>
      </div>

      <div class="box-titles">
        <strong>
          Diagram Model saved in JSON format:
        </strong>
        <strong>
          JSON code generation:
        </strong>
        <strong>
          Result:
       </strong>
      </div>

      <div class="container">
        <textarea readonly id="mySavedModel" >
        </textarea>
        <div class="controls">
          <button type="button" class="controls__button controls__button--generate" onclick="generateCode()">Generate</button>
        </div>
        <textarea readonly id="generatedModel">
        </textarea>

        <div class ="editor-toolbar-buttons">
          <div class="editor-toolbar-button-category">
            <div class="play-button"></div><!-- play -->
            <div class="pause-button"></div><!-- pause -->
          </div>
          <div class="separator"></div>
          <div class="editor-toolbar-button-category">
            <div class="step-over-button"></div><!-- step over -->
            <div class="step-into-button"></div><!-- step into -->
            <div class="step-out-button"></div><!-- step out -->
          </div>
          <div class="separator"></div>
          <div class="editor-toolbar-button-category">
            <div class="restart-button"></div><!-- restart -->
            <div class="stop-button"></div><!-- stop -->
          </div>
        </div>

        <textarea readonly id="resultModel">
        </textarea>
      </div>
      
    </div>
    </pre></div>
    
  </body>
  </html>